系统考虑假如锂聚合物电池，容量在600-800mAH。

rk805没有独立的battery充电电路和powerpath，需要一路独立的充电电路，锂电池输出和USB 5V输入OR在一起。

```
Vusb -----------------------------|>|-----------> VSYS --> PMU
          |                                  ^
          v                                  |
(linear charger) -> (battery) ----|>|---------
```

1. ORing电路仅供示意，实际电路应该考虑用MOSFET，减少不必要的功耗损失；
2. Linear Charger的充电电流尽可能低，不要超过50mA；

上述电路逻辑下，在有USB供电时，VSYS主要由USB供电，在USB断开时，电池可以短暂供电；

# Power Cycle

RK805的上电逻辑包括

1. EN引脚的上升沿
2. EN高电平时，POWER_ON assert 500ms
3. EN高电平时，RTC中断

RK805的关闭逻辑包括：
1. EN引脚低电平
2. POWER_ON assert 6-12s（可编程）
3. 过热
4. VCCA电压过低或过高
5. SLEEP信号active，IO_POL_REG bit3:2设置为turn down PMU，即SLEEP即关闭
6. 软件写入DEV_OFF

常规设计EN是Vusb和Vbatt的OR逻辑，1仅在系统无电池或电池电量过低时有意义；软件上从EN引脚开始的boot一般boot到uboot为止，系统进入休眠状态，等待POWER_ON事件。

正常关机流程是软件获得POWER_ON事件（或其他事件），开始关闭系统，最后内核驱动写入PMU的寄存器关机，即方式6。

在系统死机无法走正常关机流程时，用户可以长按POWER键强制关闭系统供电，即方式2。

在上述设计下，开机系统需要用户按键。

# Alternative

在设计上更倾向于没有用户按键的开关机行为，类似移动硬盘设备。

期望的开机行为是：USB上电即可自动开机

期望的关机行为是：

1. 用户拔掉USB供电，系统获得事件，开始软件关机流程，正常情况下最终写入DEV_OFF关机；
2. 如果软件关机过程未能在规定时间内完成软件关机流程，一个独立的延时电路强制关机；

实现该逻辑有两种方式，一个是用电路模拟开关键行为，另一个是直接控制EN，两者相比后者简单可靠。

```
Vusb -------------------------> EN
                        |
(time-delay circuit)-----
```

在这种情况下，上电即可开机，Vusb断电时，延时电路经过10-20s之后移除对EN的驱动，PMU关闭。

理论上最简单的延时电路，在EN引脚上加入RC即可；RK805的手册上没有给出EN引脚的特性。需要问rockchip。复杂一点的电路可以使用schmitt trigger或者555定时器。

# BLE & LED

加入电池设计后，BLE和LED应使用PMU的输出提供供电。这样才能保证在：

1. 系统上电时，LED可以在系统启动完成前开始闪烁；
2. 系统关机时，LED可以在Vusb移除后一直闪烁到PMU关闭；

----

以上内容我今天会发邮件给rockchip确认设计可行。有答复后告知大家。

闻上马天夫 lewis.ma@winsuntech.cn














